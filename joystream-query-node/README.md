# Joystream Query Node

Joystream query node can be generated by using `substrate-query-node/cli`.

## Getting Started

Cli create a folder named `generated` and put everthing inside it.

```
$ cli codegen
```

Start graphql server:

```
$ cd generated/graphql-server
$ yarn start:dev
```

Start block indexer:

```
$ cd generated/indexer
$ yarn start
```

## Query Node Constructs Explained

1. `schema.json` is where you define types for graphql server. Graphql server use these types to generate db models, db tables, graphql resolvers.

Below you can find a type defination example:

```json
[
	{
		"name": "MemberRegistered",
		"fields": [
			{ "name": "memberId", "type": "int!" },
			{
				"name": "accountId",
				"type": "string!"
			}
		]
	}
]
```

2. Block indexer is block consumer and every block can have events that we want to store their data. So indexing data from events we need to send the event to a function or a class that can handle the event and store the event data on database. `mappings` are the functions that we use to update our database with events data. Functions that we define in our mappings will be called only when an event name match our function name (function name pattern is `'handle' + eventName`). We call mapping functions as event handlers. Each event handler will have only one parameter which is the event that handler called for. Below you can find an example for event an handler:

```ts
// mappings/index.ts

import { QueryEvent } from "../generated/indexer/index";

export function handleMemberRegistered(event: QueryEvent) {
	console.log(`Event parameters: ${event.event_params}`);
}
```

3. Block indexer connect to a blockchain node via websockets so we need to tell block indexer where to find the address of the node. Also, on the initialization of the indexer we must pass type register function as a parameter. So we put these variables inside the `.env` file that indexer can find and use them. For Joystream we will be running a local development node and add name of the function, package for the type registrator:

```
WS_PROVIDER_ENDPOINT_URI=ws://localhost:9944
TYPE_REGISTER_PACKAGE_NAME=@joystream/types
TYPE_REGISTER_FUNCTION=registerJoystreamTypes
```
